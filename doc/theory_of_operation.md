# rosdoc2 Theory of Operation

## Overview

**rosdoc2** primarily performs these operations:

- analyzes the package.xml file for basic package information and customization.
- scans the package repository to locate various items that might be processed by **rosdoc2** such as python files, C++ files, standard documents, interfaces (message, services, and actions), and documentation.
- If C++ is found, runs Doxygen on those files to generate source code documentation (in an xml intermediary)
- If python is found, runs sphinx-apidoc on those files to generate source code documentation.
- Presents results of the various documentation sources as html using Sphinx, with the Doxygen xml interpreted through the Sphinx addons `breathe` and `exhale`.

General items are expected to be in standard locations as specified in the [ROS2 Project Developer Guide,](https://docs.ros.org/en/rolling/The-ROS2-Project/Contributing/Developer-Guide.html#filesystem-layout) but if not in most cases customizations can be specified for non-default locations.

## File locations during execution

**rosdoc2** generates a lot of intermediate files, which we don't want contaminating the package repository source. These intermediate files are placed in a single `BUILD_DIRECTORY`, which by default is the folder `doc_build` created in the current working folder. Any existing content in this folder will be deleted.

The generation of final html documentation is done by `sphinx-build`, which is run in a subdirectory of the `BUILD_DIRECTORY`. All artifacts that are needed to generate the final documentation must be in that directory or its subdirectories. These are copied as needed by **rosdoc2** from their original location, but in some cases relative links from files might not function correctly.

The final result of the documentation is placed in the `OUTPUT_DIRECTORY` which by default is the folder `doc_output` created in the current working folder.

The configuration of `sphinx-build` when used by non-ROS2 projects is typically controlled by a conf.py file that is placed in a documentation subdirectory. However, **rosdoc2** needs to include files from the entire package directory, not just from a documentation subdirectory. For that reason, normally a 'wrapping' conf.py is created in the `BUILD_DIRECTORY` to configure **rosdoc2** relative to the package directory, rather than relative to the documentation subdirectory. If the user includes a conf.py in the documentation subdirectory, any variables defined there are copied into the 'wrapping' conf.py and used for the overall project. (This can be overridden by specifying a `sphinx_sourcedir` in `rosdoc2.yaml`.)

## Detailed Operation

Although **rosdoc2** was originally written to be general with multiple possible documentation builders, at the current time there are just two builders, 'doxygen' and 'sphinx'. The 'doxygen' builder is like a preprocessor of the C++ documentation, while the remaining operations and final output are all generated using the 'sphinx' builder.

The tool follows these steps:

- Inspect the `package.xml` of the package for any rosdoc2 specific configurations (typically from a custom `rosdoc2.yaml` file).
- Run the `doxygen` builder if required.
- Run the `sphinx` builder
  - create a `wrapped_sphinx_directory` which is the parent for the documentation sources used by Sphinx.
  - generate interface documentation if any.
  - generate documentation links to standard documents like README and CHANGELOG.
  - process user documentation if any.
  - locate any intersphinx files (containing links to other documentation).
  - include various items in package.xml as documentation.
  - locate a user-specified conf.py, or generate a default version from a template.
  - create an overall project conf.py and index.rst from templates.
  - generate python documentation if needed using `sphinx-apidoc`.
  - invoke `sphinx-build` to generate the overall documentation. Any C++ documentation is processed using the Sphinx extensions `breathe` and `exhale`.

- Move the resulting files from the intermediate output directory into the output directory specified by the user.
  - Note: this step can overwrite existing files, e.g. files from a previous run of the tool, but will not delete files that are no longer generated by the documentation, so you may want to delete the output directory if you remove or rename parts of the documentation.
